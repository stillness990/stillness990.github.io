<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Well Wang的blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Well Wang的blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Well Wang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Well Wang的blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Well Wang的blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/docsify+nginx%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/docsify+nginx%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" class="post-title-link" itemprop="url">使用docsify+nginx搭建个人博客</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:46" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="1-安装docsify"><a href="#1-安装docsify" class="headerlink" title="1. 安装docsify"></a>1. 安装docsify</h4><ol>
<li>下载nodejs</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://nodejs.org/dist/v16.13.2/node-v16.13.2-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>解压</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf node-v16.13.2-linux-x64.tar</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>新建node文件夹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> node</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>移动node文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> node-v16.13.2-linux-x64 /usr/local/node</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>编辑～/.bash_profile</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nodejs</span></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/local/node/node-v12.16.3-linux-x64/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>刷新环境变量使之生效</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>查看版本</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>新建网站文件夹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line">sudo <span class="built_in">mkdir</span> www</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>安装docsify</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g docsify-cli</span><br></pre></td></tr></table></figure>

<p>10 检查版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docsify -v</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>记录一下docsify执行文件地址</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/node/node-v14.16.0-linux-x64/lib/node_modules/docsify-cli/bin</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>初始化文件夹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docsify init www</span><br></pre></td></tr></table></figure>

<ol start="14">
<li><p>开启docsifyf服务</p>
<p>只为测试docsify是否正常使用</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docsify serve www</span><br></pre></td></tr></table></figure>

<p>Serving /home/centos/www now.</p>
<p>Listening at <a target="_blank" rel="noopener" href="http://localhost:3000/">http://localhost:3000</a></p>
<p>ctrl+c 关闭进程</p>
<h4 id="2-安装nginx"><a href="#2-安装nginx" class="headerlink" title="2. 安装nginx"></a>2. 安装nginx</h4><ol>
<li>安装nginx</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>移动文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf nginx-1.18.0.tar.gz -C /usr/local/nginx/</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>移动文件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv nginx-1.18.0 /usr/local/nginx</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>安装依赖</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre-devel</span><br><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>编译安装</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>提示报错安装提示安装gcc-c++包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc-c++</span><br></pre></td></tr></table></figure>

<p>安装后继续编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configuree</span><br></pre></td></tr></table></figure>

<p>make安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make: *** No rule to make target build&#x27;, needed bydefault’. Stop.</span><br></pre></td></tr></table></figure>

<p>解决</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install make zlib-devel gcc-c++ libtool openssl openssl-devel</span><br></pre></td></tr></table></figure>

<p>重新配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --user=nobody --group=nobody --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_gzip_static_module --with-http_realip_module --with-http_sub_module --with-http_ssl_module</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>编译后的nginx执行文件</li>
</ol>
<blockquote>
<p>编译后的执行文件在objs文件夹里面，之前的执行文件在sbin里面，这里我就先不替换旧的了</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/nginx/nginx-1.18.0/objs/nginx</span><br></pre></td></tr></table></figure>

<p><strong>记录一下配置文件地址</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/nginx-1.18.0/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p><strong>网站文件地址</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/centos/www</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>启动nginx</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[centos@ip-172-26-0-117 objs]$ ./nginxnginx: [alert] could not open error log file: open() &quot;/usr/local/nginx/logs/error.log&quot; failed (2: No such file or directory)2022/01/28 06:21:38 [emerg] 13612#0: open() &quot;/usr/local/nginx/conf/nginx.conf&quot; failed (2: No such file or directory)</span><br></pre></td></tr></table></figure>

<p>移动文件配置文件到目标文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<p>目标文件家新建文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/logs/error.log</span><br></pre></td></tr></table></figure>

<p>正常启动nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/nginx/nginx-1.18.0/objs/./nginx</span><br></pre></td></tr></table></figure>

<hr>
<ol start="8">
<li>问题排查</li>
</ol>
<p>启动nginx后显示403</p>
<p>于是查看nginx日志，路径为/var/log/nginx/error.log。打开日志发现报错Permission denied</p>
<p>于是按照以下的步骤进行排查</p>
<ol>
<li>由于启动用户和nginx工作用户不一致所致，使用命令查看nginx用户组</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep &quot;nginx: worker process&quot;</span><br></pre></td></tr></table></figure>

<p>发现nginx的启动用户为nobaby而非root启动</p>
<p>编辑nginx.conf文件，使usr与启动用户一致</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nano /usr/local/nginx/conf/nginx.conf</span><br><span class="line">user root</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>缺少index.html或者index.php文件，就是配置文件中index index.html index.htm这行中的指定的文件。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server &#123;  </span><br><span class="line"></span><br><span class="line">listen       80;  </span><br><span class="line"></span><br><span class="line">server_name  localhost;  </span><br><span class="line"></span><br><span class="line">index  index.php index.html;  </span><br><span class="line"></span><br><span class="line">root  /data/www/; #此处为网站文件地址，如果没有index.html或者inex.php文件就显示403</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>权限问题，如果nginx没有web目录的操作权限，也会出现403错误。</p>
<p>解决办法：修改web目录的读写权限，或者是把nginx的启动用户改成目录的所属用户，重启Nginx即可解决</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 /data #网站文件</span><br><span class="line"></span><br><span class="line">chmod -R 777 /data/www/ #网站文件</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>开启网站目录的方法</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;undefined</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        charset utf-8;</span><br><span class="line">        autoindex on;  #不加是不会显示目录的</span><br><span class="line">        location / &#123;undefined</span><br><span class="line">            root   /ftpfile/img2;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结束进程和启动nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep nginx</span><br><span class="line">kill -9 pid #结束nginx进程</span><br><span class="line">sudo /usr/local/nginx/nginx-1.18.0/objs/./nginx #启动nginx</span><br></pre></td></tr></table></figure>

<h4 id="3-使用syncthing同步本地文件和服务器文件"><a href="#3-使用syncthing同步本地文件和服务器文件" class="headerlink" title="3. 使用syncthing同步本地文件和服务器文件"></a>3. 使用syncthing同步本地文件和服务器文件</h4><p>sync文件地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/syncthinx</span><br></pre></td></tr></table></figure>

<p>移动syncthing文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv syncthing-linux-amd64-v1.18.4.tar.gz /usr/local/syncthinx/</span><br></pre></td></tr></table></figure>

<p>解压文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf syncthing-linux-amd64-v1.18.4.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压后的syncthing文件地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/syncthinx/syncthing-linux-amd64-v1.18.4</span><br></pre></td></tr></table></figure>

<p>添加执行权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x syncthing</span><br></pre></td></tr></table></figure>

<p>执行程序生成配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./syncthing</span><br></pre></td></tr></table></figure>

<p>配置文件地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/centos/.config/sycthing/config.xml</span><br></pre></td></tr></table></figure>

<p>编辑config.xml文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;address&gt;127.0.0.1:8383&lt;/address&gt; #修改IP地址为0.0.0.0：8384</span><br></pre></td></tr></table></figure>

<p>打开云服务器的8384端口（web控制台接口），22000数据传输端口</p>
<p>至此，可以实现本地编辑文件然后网站文件自动更新</p>
<p>补充几个nginx命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload：重新加载nginx配置</span><br><span class="line">nginx -s stop：强制停止nginx</span><br><span class="line">nginx -s quit：优雅停止nginx</span><br><span class="line">nginx -t：修改配置之后【测试】配置是否正确</span><br><span class="line">nginx：默认启动nginx</span><br></pre></td></tr></table></figure>

<p>文件地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/home/centos/www                                             #网站文件位置</span><br><span class="line">/usr/local/nginx/conf/nginx.conf                             #nginx配置文件地址</span><br><span class="line">/usr/local/nginx/logs/error.log                              #nginx错误文件地址</span><br><span class="line">/usr/local/nginx/nginx-1.18.0/objs/nginx                     #nginx执行文件地址</span><br><span class="line">/home/centos/.config/sycthing/config.xml                     #syncthing配置文件地址</span><br><span class="line">/usr/local/syncthinx/syncthing-linux-amd64-v1.18.4/syncthing #syncthing执行文件地址</span><br></pre></td></tr></table></figure>

<p>end</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/http%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/http%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">nginx代理服务器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:48" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>代理服务器选择使用tinyproxy开源工具，轻量级，简单好用。下面是搭建步骤：</p>
<p>环境：</p>
<p>centos7</p>
<p>tinyproxy</p>
<ol>
<li><p>下载tinyproxy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install tinyproxy -y</span><br></pre></td></tr></table></figure></li>
<li><p>修改配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/tinyproxy/tinyproxy.conf</span><br></pre></td></tr></table></figure>
<h1 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 8888  </span><br></pre></td></tr></table></figure>
<h1 id="允许访问的ip，后面接允许的ip，比如我只需要我阿里云的公网ip能访问就行，于是用阿里云公网ip替换127-0-0-1。如果要所有ip均可访问就注释掉此配置"><a href="#允许访问的ip，后面接允许的ip，比如我只需要我阿里云的公网ip能访问就行，于是用阿里云公网ip替换127-0-0-1。如果要所有ip均可访问就注释掉此配置" class="headerlink" title="允许访问的ip，后面接允许的ip，比如我只需要我阿里云的公网ip能访问就行，于是用阿里云公网ip替换127.0.0.1。如果要所有ip均可访问就注释掉此配置"></a>允许访问的ip，后面接允许的ip，比如我只需要我阿里云的公网ip能访问就行，于是用阿里云公网ip替换127.0.0.1。如果要所有ip均可访问就注释掉此配置</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Allow 127.0.0.1</span><br></pre></td></tr></table></figure>
<h1 id="性能配置，一般不需要修改，根据需要进行调整。（这里我没有修改）"><a href="#性能配置，一般不需要修改，根据需要进行调整。（这里我没有修改）" class="headerlink" title="性能配置，一般不需要修改，根据需要进行调整。（这里我没有修改）"></a>性能配置，一般不需要修改，根据需要进行调整。（这里我没有修改）</h1></li>
</ol>
<p>MaxClients 100<br>MinSpareServers 5<br>MaxSpareServers 20<br>StartServers 10<br>MaxRequestsPerChild 0<br>MaxRequestsPerChild 0</p>
<ol start="3">
<li><p>启动服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start tinyproxy</span><br></pre></td></tr></table></figure></li>
<li><p>开放端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=8888/tcp --permanent  # 开发的端口为你上面配置的端口</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></li>
<li><p>使用浏览器测试代理是否能正常使用<br>以chrome为例，点击设置 –&gt; 高级 –&gt; 打开代理设置。  进入如下配置，将代理服务器的ip和port填写进去即可。</p>
<img src="../img/.http.png" width="50%"></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/linux%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/linux%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4/" class="post-title-link" itemprop="url">linux交换空间</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:50" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>查看现在的swappiness</p>
<pre><code>cat /proc/sys/vm/swappiness
</code></pre>
<p>swappiness=0的时候表示最大限度使用物理内存，然后才是 swap空间，</p>
<p>swappiness＝100的时候表示积极的使用swap分区，并且把内存上的数据及时的搬运到swap空间里面。</p>
<p>临时修改swappiness参数.这里设置的10</p>
<pre><code>sysctl vm.swappiness=10
</code></pre>
<p>永久修改<br>在/etc/sysctl.conf文件中添加如下参数，这里设置的10</p>
<pre><code>vm.swappiness=10
</code></pre>
<p>设置好后一定要启用激活</p>
<pre><code>sysctl -p
</code></pre>
<p>增加和删除swap分区<br>查看现在正在使用的swap</p>
<pre><code>free
</code></pre>
<ol>
<li> 使用dd命令创建一个swap分区，在这里创建一个4G的分区</li>
</ol>
<pre><code>dd if=/dev/zero of=/root/swapfile bs=1M count=4096
</code></pre>
<p> if=文件名：表示指定源文件</p>
<p> of=文件名：表示指定目的文件，可以自己去设定目标文件路径。</p>
<p> bs=xx：同时设置读入/写出的“块”大小</p>
<p>count=xx：表示拷贝多少个“块”</p>
<p>bs * count 为拷贝的文件大小，即swap分区大小<br>2, 格式化新建的分区文件</p>
<pre><code>mkswap /root/swapfile
</code></pre>
<ol start="3">
<li> 将新建的分区文件设为swap分区</li>
</ol>
<pre><code>swapon /root/swapfile
</code></pre>
<ol start="4">
<li> 设置开机自动挂swap分区</li>
</ol>
<pre><code>echo &quot;/root/swapfile swap swap defaults 0 0&quot; &gt;&gt; /etc/fstab
</code></pre>
<ol start="5">
<li> 最后使用free -h查看分区情况</li>
<li> 删除swap分区</li>
</ol>
<pre><code>swapoff /root/swapfile
rm -rf /root/swap
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%A4%87%E7%94%A8%E6%89%8B%E5%86%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%A4%87%E7%94%A8%E6%89%8B%E5%86%8C/" class="post-title-link" itemprop="url">linux速查手册</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:50" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <table>
<thead>
<tr>
<th align="center">shutdown -h now</th>
<th align="center">即刻关机</th>
</tr>
</thead>
<tbody><tr>
<td align="center">shutdown -h 10</td>
<td align="center">10分钟后关机</td>
</tr>
<tr>
<td align="center">shutdown -h 11:00</td>
<td align="center">11点关机</td>
</tr>
<tr>
<td align="center">shutdown -h +10</td>
<td align="center">预订10分钟后关机</td>
</tr>
<tr>
<td align="center">shutdown -c</td>
<td align="center">取消关机</td>
</tr>
<tr>
<td align="center">shutdown -r now</td>
<td align="center">重启</td>
</tr>
<tr>
<td align="center">shutdown -r 10</td>
<td align="center">10分钟后重启</td>
</tr>
<tr>
<td align="center">shutdown -r 11：00</td>
<td align="center">11点重启</td>
</tr>
<tr>
<td align="center">reboot</td>
<td align="center">重启</td>
</tr>
<tr>
<td align="center">init 6</td>
<td align="center">重启</td>
</tr>
<tr>
<td align="center">init 0</td>
<td align="center">立刻关机</td>
</tr>
<tr>
<td align="center">telinlt 0</td>
<td align="center">关机</td>
</tr>
<tr>
<td align="center">poweroff</td>
<td align="center">关机</td>
</tr>
<tr>
<td align="center">sync</td>
<td align="center">buff数据同步到磁盘</td>
</tr>
<tr>
<td align="center">logout</td>
<td align="center">退出登录shell</td>
</tr>
<tr>
<td align="center">uname -a</td>
<td align="center">查看内核/os/cpu信息</td>
</tr>
<tr>
<td align="center">uname -r</td>
<td align="center">查看内核版本</td>
</tr>
<tr>
<td align="center">uname -m</td>
<td align="center">查看处理器架构</td>
</tr>
<tr>
<td align="center">hostname</td>
<td align="center">查看计算机名</td>
</tr>
<tr>
<td align="center">who</td>
<td align="center">查看当前登录系统用户</td>
</tr>
<tr>
<td align="center">who am i</td>
<td align="center">显示登陆时的用户名</td>
</tr>
<tr>
<td align="center">whoami</td>
<td align="center">显示当前用户名</td>
</tr>
<tr>
<td align="center">cat /proc/version</td>
<td align="center">查看linux版本信息</td>
</tr>
<tr>
<td align="center">free -h</td>
<td align="center">查看系统内存用量和交换区用量</td>
</tr>
<tr>
<td align="center">date</td>
<td align="center">显示系统时间</td>
</tr>
<tr>
<td align="center">cal 2021</td>
<td align="center">显示2021年日历</td>
</tr>
<tr>
<td align="center">top</td>
<td align="center">动态显示cpu内存进程情况</td>
</tr>
<tr>
<td align="center">fdisk -l</td>
<td align="center">查看所有磁盘分区</td>
</tr>
<tr>
<td align="center">swapon -s</td>
<td align="center">查看所有交换分区</td>
</tr>
<tr>
<td align="center">df -h</td>
<td align="center">查看所有磁盘使用情况及挂载点</td>
</tr>
<tr>
<td align="center">df -hl</td>
<td align="center">同上</td>
</tr>
<tr>
<td align="center">du -sh /dir</td>
<td align="center">查看制定目录的大小</td>
</tr>
<tr>
<td align="center">mount /dev/sda2 /mnt/sda2</td>
<td align="center">挂载sda2盘</td>
</tr>
<tr>
<td align="center">passwd</td>
<td align="center">修改密码</td>
</tr>
<tr>
<td align="center">last</td>
<td align="center">查看用户登录日志</td>
</tr>
<tr>
<td align="center">ifconfig</td>
<td align="center">查看网络接口属性</td>
</tr>
<tr>
<td align="center">ifconfig eth0</td>
<td align="center">查看莫个网卡的配置</td>
</tr>
<tr>
<td align="center">route -n</td>
<td align="center">查看路由表</td>
</tr>
<tr>
<td align="center">netstat -lntp</td>
<td align="center">查看所有监听端口</td>
</tr>
<tr>
<td align="center">netstat -antp</td>
<td align="center">查看已经建立的TCP链接</td>
</tr>
<tr>
<td align="center">netstat -ntulp | grep 80</td>
<td align="center">查看80端口情况</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>netstat -lutp</td>
<td>查看TCP/UDP的状态信息</td>
</tr>
<tr>
<td>ifup eth0</td>
<td>启用eth0 网络设备</td>
</tr>
<tr>
<td>ifdown eth0</td>
<td>禁用eth0设备</td>
</tr>
<tr>
<td>ifconfig eth0 192.168.1.1 netmask 255.255.255.0</td>
<td>配置eth0 IP地址</td>
</tr>
<tr>
<td>dhclient eth0</td>
<td>dhcp模式启用eth0</td>
</tr>
<tr>
<td>route add -net 0/0 gw Gateway_IP</td>
<td>配置默认网管</td>
</tr>
<tr>
<td>host <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a></td>
<td>解析主机名</td>
</tr>
<tr>
<td>nslookup</td>
<td>查询DNS记录 查看域名名称解析是否正确</td>
</tr>
<tr>
<td>ps -ef</td>
<td>查看所有进程</td>
</tr>
<tr>
<td>ps -ef | grep name</td>
<td>查看需要的程序进程</td>
</tr>
<tr>
<td>kill -s name</td>
<td>kill 制定进程</td>
</tr>
<tr>
<td>chkconfig –list</td>
<td>列出系统服务</td>
</tr>
<tr>
<td>systemctl status &lt;服务名&gt;</td>
<td>查看某个服务</td>
</tr>
<tr>
<td>systemctl start &lt;服务名&gt;</td>
<td>启动某个服务</td>
</tr>
<tr>
<td>systemctl  stop &lt;服务名&gt;</td>
<td>终止某个服务</td>
</tr>
<tr>
<td>systemctl restart &lt;服务名&gt;</td>
<td>重启某个服务</td>
</tr>
<tr>
<td>systemctl status &lt;服务名&gt;</td>
<td>查看某个服务</td>
</tr>
<tr>
<td>systemctl start &lt;服务名&gt;</td>
<td>启动某个服务</td>
</tr>
<tr>
<td>journalctl -u &lt;服务名&gt;</td>
<td>查看某个服务日志</td>
</tr>
<tr>
<td>journalctl -f</td>
<td>查看服务日志</td>
</tr>
<tr>
<td>systemctl disable &lt;服务名&gt;</td>
<td>关闭自启动</td>
</tr>
<tr>
<td>systemctl list-unit-files</td>
<td>查看已经激活的服务</td>
</tr>
<tr>
<td>pidof &lt;程序名&gt;</td>
<td>查看某个程序的进程号</td>
</tr>
<tr>
<td>ls</td>
<td>查看文件目录列表</td>
</tr>
<tr>
<td>ll</td>
<td>显示所有文件和属性</td>
</tr>
<tr>
<td>dir</td>
<td>显示文件</td>
</tr>
<tr>
<td>pwd</td>
<td>显示当前路径</td>
</tr>
<tr>
<td>mv old_dir new_dir</td>
<td>重命名/移动目录</td>
</tr>
<tr>
<td>cp -a dir1 dir2</td>
<td>复制名录</td>
</tr>
<tr>
<td>find -name file</td>
<td>从根目录搜索文件目录</td>
</tr>
<tr>
<td>find /dir -name *.bin</td>
<td>在目录dir中搜索所有.bin后缀的文件</td>
</tr>
<tr>
<td>locate *.mp4</td>
<td>寻找所有.mp4文件</td>
</tr>
<tr>
<td>locate &lt;关键字&gt;</td>
<td>快速定位文件</td>
</tr>
<tr>
<td>which</td>
<td>快速查找文件位置</td>
</tr>
<tr>
<td>chmod +</td>
<td>设置文件读写权限</td>
</tr>
<tr>
<td>chown arch:arch *</td>
<td>设置这个目录下所有文件的用户组和用户</td>
</tr>
<tr>
<td>cat rfile1</td>
<td>查看文件内容</td>
</tr>
<tr>
<td>cat -n file1</td>
<td>查看文件内容并标识行数</td>
</tr>
<tr>
<td>more file1</td>
<td>查看一个长文件内容</td>
</tr>
<tr>
<td>grep code hello.txt</td>
<td>在hello.txt中查找关机词code</td>
</tr>
<tr>
<td>sed -n ‘5p;5q’hello.txt</td>
<td>查看第五行</td>
</tr>
<tr>
<td>zip XX.zip file</td>
<td>压缩至zip包</td>
</tr>
<tr>
<td>zip -r XXX.zip file1 file2 dir1</td>
<td>将多个文件+目录压成zip包</td>
</tr>
<tr>
<td>unzip XXX.zip</td>
<td>解压缩zip包</td>
</tr>
<tr>
<td>tar -cvf XXX.tar rile</td>
<td>创建非压缩tar包</td>
</tr>
<tr>
<td>tar -tf xxx.tar</td>
<td>查看tar包内容</td>
</tr>
<tr>
<td>tar -xvf xxx.tar</td>
<td>解压tar包</td>
</tr>
<tr>
<td>tar -xvf xxx.tar -C /dir</td>
<td>解压至某个文件</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/nextcloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/nextcloud/" class="post-title-link" itemprop="url">ubuntu下云盘搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:51" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>自己部署的 NextCloud 云盘服务具有以下优点：</p>
<p>开放灵活。NextCloud 是一套开源的云盘系统，本身功能非常成熟可靠。而且支持插件定制，应用商店中有很多好用的插件可以使用。</p>
<p>便于访问。支持通过 PC 端、移动端、浏览器来使用。跨端同步你的文件，随时随地都能访问你的数据。你还可以将你的文件分享给朋友或同事。</p>
<p>高效工作。你可以在线查看 PDF、文档、照片、视频，甚至在线编辑流程图、思维导图！它不仅仅是一个云盘，更是一个高效的个人工作台。</p>
<p>自主可控。服务就部署在你自己的服务器上，你甚至可以将它部署在封闭的内网环境中（比如公司内网）。再也不用担心云盘数据安全，也不用担心云盘厂商哪天跑路了。</p>
<p>多人协作。支持任意多个用户，每个人拥有独立的云盘空间。多个用户之间可以共享文件夹，并协同编辑文档。适合家庭和小型企业使用。</p>
<h4 id="部署步骤"><a href="#部署步骤" class="headerlink" title="部署步骤"></a>部署步骤</h4><p>这里使用阿里云 服务器</p>
<ol>
<li> 云服务器。</li>
</ol>
<p>由于本教程是个人云盘场景，因此推荐实例规格选择突发性能实例系列的。因为云盘场景不需要时刻都满负载计算，仅仅在你使用云盘时需要跑满负载。因此，选择突发性能实例系列的性价比更高（相同配置价格更低）。</p>
<p>操作系统要选择 Ubuntu 20.04 的。否则本教程中的命令可能不适用。</p>
<p>网络带宽计费模式建议选择按使用流量。理由与第一点相同。带宽峰值建议设置高一些，12Mbps 以上（带宽峰值速率不会增加费用，因为是按流量计费的）。</p>
<p>在配置网络和安全组的时候，要勾选开放端口 80 和 443。否则云盘服务无法被访问到。如果你选择的是已有的安全组，确保它开放了端口 80 和 443。</p>
<p>登录云服务器</p>
<p>通过阿里云控制台，远程连接到云服务器。连接方式建议选择Workbench远程连接，用起来比较方便。</p>
<p>后续操作皆在云服务器中完成。</p>
<ol start="2">
<li> 安装并启用 docker</li>
</ol>
<p>docker 是一款开源的容器运行工具，提供了一套便捷的服务打包、分发、部署方式。我们将要部署的服务就是通过 docker 容器来运行的。</p>
<p>依次执行以下命令，通过自动化脚本完成 docker 安装：</p>
<pre><code>curl -fsSL get.docker.com -o get-docker.sh

sudo sh get-docker.sh --mirror Aliyun
</code></pre>
<p>直接拷贝上述文本到命令行中执行时，由于最后一行缺少换行符，因此需要你再手动按一次回车，来执行最后一条命令。</p>
<p>依次执行以下命令，启用 docker：</p>
<pre><code>sudo systemctl enable docker

sudo systemctl start docker
</code></pre>
<ol start="3">
<li> 安装 docker-compose</li>
</ol>
<p>docker-compose 是一款基于 docker 的容器编排工具。有了它，我们通过一份配置文件就能启动所有需要的服务。因此我们先来安装它：</p>
<pre><code>sudo curl -L https://download.fastgit.org/docker/compose/releases/download/1.27.4/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose

sudo chmod +x /usr/local/bin/docker-compose
</code></pre>
<ol start="4">
<li> 安装 git</li>
</ol>
<p>我们将使用 git 来拉取模板项目，因此请先安装 git：</p>
<pre><code>sudo apt install git
</code></pre>
<p>准备 NextCloud 部署配置</p>
<p>将我们提前配置好的部署环境克隆到服务器上：</p>
<pre><code>git clone https://gitee.com/csr632/nextcloud-example

cd nextcloud-example
</code></pre>
<p>执行配置修改脚本，它会自动将docker-compose.yml中的 IP 占位符your.domain.name替换成【你的服务器公网 IP】：</p>
<pre><code>chmod +x ./prepare.sh

./prepare.sh 你的服务器公网IP
</code></pre>
<p>注意将上面命令的【你的服务器公网 IP】替换成你的云服务器 IP。</p>
<p>然后，就可以启动所有 docker 容器了：</p>
<pre><code>docker-compose up -d
</code></pre>
<p>初次执行此命令时，会花费一些时间来拉取 docker 镜像。</p>
<p>通过浏览器访问<a target="_blank" rel="noopener" href="https://你的ecs服务器公网ip.就可以访问你的私人云盘服务了!/">https://你的ECS服务器公网IP。就可以访问你的私人云盘服务了！</a></p>
<p>注意，初次访问时，浏览器会提示“您的连接不是私密连接”。你需要依次点击“高级 - 继续前往（不安全）”。这里以 Chrome 浏览器为例，其他浏览器类似。</p>
<p>之所以有这个警告，是因为我们部署 NextCloud 服务的时候，使用 IP 地址作为服务主机名，因此只能使用自签名的 https 证书来实现加密通信，而浏览器默认不会信任自签名的证书。 目前没有免费的方式得到基于 IP 主机名的权威 https 证书。未来当你有了自己的域名以后，可以申请免费的权威 https 证书，避免初次访问时手动信任证书。</p>
<p>完成上述步骤以后，你就真正看到了你的 NextCloud 服务！初次使用时，它会引导你注册一个管理员账号。然后你就可以尽情探索了！</p>
<p>注册管理员账号时，不要勾选“install apps”，原因参考下面的注意事项。你可以登录成功以后再到应用商店下载。 初次注册管理账号时，会比较慢，可能会造成网页请求超时。没关系，注册管理账号的过程依然在背后默默进行。刷新页面以后你依然使用刚才注册的管理账号来登录即可。可能需要刷新页面重试几次。</p>
<p>成功进入云盘以后，建议你先将应用语言修改成中文：右上角 - Settings - Language - 简体中文。然后就开始尽情探索吧！</p>
<p>推荐应用</p>
<p>NextCloud 的其中一个核心亮点是，可以从应用商店安装新的应用到你的 NextCloud 服务中。你可以依次点击右上角 - 应用来管理你的应用。</p>
<p>下面推荐几款我正在使用的应用：</p>
<p>Draw.io 大名鼎鼎的画图神器，各种 UML 图、线框图都可以画！在线画图，点击保存，随处访问！</p>
<p>Mind Map 专门用来画思维导图的神器。</p>
<p>Markdown Editor 让你可以直接在线编辑 Markdown 文件。</p>
<p>Notes 笔记本功能。安装以后顶栏会出现一个笔记按钮，管理笔记更加方便。</p>
<p>还有更多优质应用等待你探索！</p>
<p>注意事项</p>
<p>由于 NextCloud 的应用商店服务器在国外，从国内的服务器连接过去经常会超时。因此如果遇到应用安装失败的话需要重试几次。</p>
<p>使用客户端</p>
<p>如果希望在手机或平板上使用，可以在 Google Play 或者苹果 App Store 下载 NextCloud 的客户端。 对于国内无法使用 Google Play 的用户，可以直接到NextCloud 的 Github下载 apk 安装包。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/nginx%E4%BB%A3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/nginx%E4%BB%A3%E7%90%86/" class="post-title-link" itemprop="url">nginx代理服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:51" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>安装nginx</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://nginx.org/download/nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>解压到制定目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf nginx-1.18.0.tar.gz -C /usr/local/nginx/</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装依赖</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre-devel</span><br><span class="line">yum -y install openssl openssl-devel</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编译安装</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>make安装</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>make后的执行文件地址是</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/nginx-1.18.0/objs/nginx</span><br></pre></td></tr></table></figure>

<p>复制make后的执行文件到sbin文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>nano完配置文件后报错<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx: [emerg] unknown directive &quot;ssl_certificate&quot; in /usr/local/nginx/conf/nginx.conf:102</span><br></pre></td></tr></table></figure>
由于我的场景已经安装了nginx 但是没有安装with-http_ssl_module，所以我需要重新编译</li>
</ol>
<p>进入nginx编译文件夹进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/nginx/nginx-1.18.0</span><br><span class="line">$ ./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module</span><br><span class="line">nginx path prefix: &quot;/usr/local/nginx&quot;  </span><br><span class="line">nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;  </span><br><span class="line">nginx modules path: &quot;/usr/local/nginx/modules&quot;  </span><br><span class="line">nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;  </span><br><span class="line">nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;  </span><br><span class="line">nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;  </span><br><span class="line">nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>
<p>检查结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./nginx -V #查看nginx安装情况</span><br><span class="line">nginx version: nginx/1.18.0</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC)</span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>make后的执行文件地址是</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/nginx-1.18.0/objs/nginx</span><br></pre></td></tr></table></figure>

<p>再次复制make后的执行文件到sbin文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>

<p>报错排查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[admin@iZt4na5bkc7wj3f80j7z8oZ sbin]$ sudo ./nginx -tnginx: [emerg] invalid URL prefix in /usr/local/nginx/conf/nginx.conf:113</span><br><span class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test failed</span><br></pre></td></tr></table></figure>

<p>意思是网站链接不被允许，查看写的代理链接是否正确。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;proxy_pass&quot; directive is not allowed here in /usr/local/nginx/conf/nginx.conf:20</span><br><span class="line"># 意思是proxy_pass不在这个位置，查询资料后这一段应该在http&#123;&#125;里面</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/nginx%E9%85%8D%E7%BD%AEssl%E8%AF%81%E4%B9%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/nginx%E9%85%8D%E7%BD%AEssl%E8%AF%81%E4%B9%A6/" class="post-title-link" itemprop="url">nginx配置证书</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:55" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="一、Http与Https的区别"><a href="#一、Http与Https的区别" class="headerlink" title="一、Http与Https的区别"></a>一、Http与Https的区别</h4><blockquote>
<p>HTTP：是互联网上应用最为广泛的一种网络协议，是一个客户端和服务器端请求和应答的标准（TCP），用于从WWW服务器传输超文本到本地浏览器的传输协议，它可以使浏览器更加高效，使网络传输减少。</p>
<p>HTTPS：是以安全为目标的HTTP通道，简单讲是HTTP的安全版，即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。HTTPS协议的主要作用可以分为两种：一种是建立一个信息安全通道，来保证数据传输的安全；另一种就是确认网站的真实性。<br>HTTPS和HTTP的区别主要如下：</p>
<pre><code>1、https协议需要到ca申请证书，一般免费证书较少，因而需要一定费用。
2、http是超文本传输协议，信息是明文传输，https则是具有安全性的ssl加密传输协议。
3、http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。
4、http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。
</code></pre>
</blockquote>
<h4 id="二、-使用openssl生成证书"><a href="#二、-使用openssl生成证书" class="headerlink" title="二、 使用openssl生成证书"></a>二、 使用openssl生成证书</h4><p>这里使用的是openssl</p>
<p>先检查是否安装了openssl，按照结果显示我已经安装了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo yum install openssl</span><br><span class="line">Loaded plugins: fastestmirrorLoading mirror speeds from cached hostfile * base: download.cf.centos.org * extras: download.cf.centos.org * updates: download.cf.centos.orgbase                                                    | 3.6 kB     00:00     extras                                                  | 2.9 kB     00:00     updates                                                 | 2.9 kB     00:00     Package 1:openssl-1.0.2k-24.el7_9.x86_64 already installed and latest versionNothing to do</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>生成证书</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 36500 -newkey rsa:2048 -keyout /u    sr/local/ssl/nginx.key -out /usr/local/ssl/nginx.crt</span><br></pre></td></tr></table></figure>
<p>生成过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Generating a 2048 bit RSA private key</span><br><span class="line"></span><br><span class="line">...............................................................................+    ++</span><br><span class="line">...............+++</span><br><span class="line">writing new private key to &#x27;/usr/local/ssl/nginx.key&#x27;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN                          #地区</span><br><span class="line">State or Province Name (full name) []:beijing                 #城市</span><br><span class="line">Locality Name (eg, city) [Default City]:beijing               #城市</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:xxxx    #行业，一般是IT</span><br><span class="line">Organizational Unit Name (eg, section) []:xxxx                #公司名，可不写</span><br><span class="line">Common Name (eg, your name or your server&#x27;s hostname) []:XXXX #填写域名</span><br><span class="line">Email Address []:xxxx@xxxx.com                                #联系邮件，可不填</span><br><span class="line"># ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r--. 1 root root 1391 Apr 21 13:29 nginx.crt           #ssl证书</span><br><span class="line">-rw-r--r--. 1 root root 1704 Apr 21 13:29 nginx.key</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>nano完配置文件后报错<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx: [emerg] unknown directive &quot;ssl_certificate&quot; in /usr/local/nginx/conf/nginx.conf:102</span><br></pre></td></tr></table></figure>
由于我的场景已经安装了nginx 但是没有安装with-http_ssl_module，所以我需要重新编译</li>
</ol>
<p>进入nginx编译文件夹进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cd /usr/local/nginx/nginx-1.18.0</span><br><span class="line">$ ./configure --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module</span><br><span class="line">nginx path prefix: &quot;/usr/local/nginx&quot;  </span><br><span class="line">nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;  </span><br><span class="line">nginx modules path: &quot;/usr/local/nginx/modules&quot;  </span><br><span class="line">nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;  </span><br><span class="line">nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;  </span><br><span class="line">nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;  </span><br><span class="line">nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>
<p>检查结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./nginx -V #查看nginx安装情况</span><br><span class="line">nginx version: nginx/1.18.0built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) built with OpenSSL 1.0.2k-fips  26 Jan 2017TLS SNI support enabledconfigure arguments: --prefix=/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module #现在已经安装完成了</span><br></pre></td></tr></table></figure>

<p>编辑nginx.conf文件</p>
<p>先备份之前的配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp nginx.conf /usr/local/nginx/conf/nginx.conf.bak</span><br></pre></td></tr></table></figure>

<p>编辑文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">user  root;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">#error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">#    keepalive_timeout  0;</span><br><span class="line">#    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  XXXXXX.com;  #域名</span><br><span class="line">	rewrite ^(.*) https://$server_name$1 permanent;  #强制跳转导https</span><br><span class="line">        charset utf-8;</span><br><span class="line">        autoindex on;</span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">	    root  /home/centos/www;</span><br><span class="line">            index</span><br><span class="line">            index.html</span><br><span class="line">            index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">       listen       443 ssl;</span><br><span class="line">       server_name  XXXX.com;                         #域名</span><br><span class="line">#       ssl on;    </span><br><span class="line">       ssl_certificate      usr/local/ssl/nginx.crt; #ssl证书绝对路径</span><br><span class="line">       ssl_certificate_key  usr/local/ssl/nginx.key; #ssl证书绝对路径</span><br><span class="line">#       ssl_session_cache    shared:SSL:1m;</span><br><span class="line">       ssl_session_timeout  5m;</span><br><span class="line">       ssl_protocols TLSv1 TLSv1.1 TLSv1.2;     #表示使用的TLS协议的类型。</span><br><span class="line">       autoindex on;</span><br><span class="line">       server_tokens        off;                #关闭服务器版本号</span><br><span class="line">       ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">       ssl_prefer_server_ciphers  on;</span><br><span class="line">#       fasrcgi_parm HTTPS:        on;</span><br><span class="line">       location / &#123;</span><br><span class="line">             root   /home/centos/www;          #文件地址</span><br><span class="line">             index  </span><br><span class="line">             index.html</span><br><span class="line">             index.htm;</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>排错环节</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">the &quot;ssl&quot; parameter requires ngx_http_ssl_module</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>收到报错：您需要重新编译Nginx并在编译安装的时候加上<code>--with-http_ssl_module</code>配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;/cert/3970497_pic.certificatestests.com.pem&quot;:BIO_new_file() failed (SSL: error:02001002:system library:fopen:No such file or directory:fopen(&#x27;/cert/3970497_pic.certificatestests.com.pem&#x27;,&#x27;r&#x27;) error:2006D080:BIO routines:BIO_new_file:no such file)`</span><br></pre></td></tr></table></figure>

<p>  需要去掉证书相对路径最前面的<code>/</code>。例如，您需要去掉<code>/cert/cert-file-name.pem</code>最前面的<code>/</code>，</p>
<p>使用正确的相对路径<code>cert/cert-file-name.pem</code>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/nginx%E9%85%8D%E7%BD%AE%E5%AE%89%E5%85%A8ssl%E8%AF%81%E4%B9%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/nginx%E9%85%8D%E7%BD%AE%E5%AE%89%E5%85%A8ssl%E8%AF%81%E4%B9%A6/" class="post-title-link" itemprop="url">nginx使用安全证书</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:53" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="使用免费安全ssl证书"><a href="#使用免费安全ssl证书" class="headerlink" title="使用免费安全ssl证书"></a>使用免费安全ssl证书</h4><p>作为强迫症患者，实在受不了浏览器访问是出现的不安全提示，所有使用阿里云的免费证书重新布置了一遍证书</p>
<p>我的域名是阿里云的 我可以免费申请10个ssl证书，在阿里云的ssl证书里面下载即可（选择nginx证书）</p>
<p>申请过程很快，申请来以后下载即可，</p>
<p>同时使用阿里云的DNS控制台解析ssl证书</p>
<p>结束nginx进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx #显示nginx进程</span><br><span class="line">kill -9 pdi         #结束nginx进程</span><br></pre></td></tr></table></figure>

<p>编辑nginx.conf文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    root html;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">    ssl_certificate cert/cert-file-name.pem;   #需要将cert-file-name.pem替换成已上传的证书文件的名称。</span><br><span class="line">    ssl_certificate_key cert/cert-file-name.key;   #需要将cert-file-name.key替换已上传的证书私钥文件的名称。</span><br><span class="line">    ssl_session_timeout 5m;</span><br><span class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试有没有问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/nginx/nginx-1.18.0/objs/nginx -t</span><br></pre></td></tr></table></figure>

<p>看看nginx报错日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/local/nginx/logs/error.log</span><br></pre></td></tr></table></figure>

<p>运行nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/local/nginx/nginx-1.18.0/objs/nginx</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90/" class="post-title-link" itemprop="url">nginx配置文件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:54" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>内容转载</p>
<p>原文地址<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/teiygsurivE4oRL9IeIrSg">https://mp.weixin.qq.com/s/teiygsurivE4oRL9IeIrSg</a></p>
<p>Nginx 是一个非常高性能的 Web 服务器，具有处理大型站点的能力。由于它能够处理多个并发连接，因此非常受欢迎。由于许多其他原因，它也是首选，例如：<br>其异步事件驱动架构</p>
<p>内存使用率低</p>
<p>负载均衡</p>
<p>带 SNI 的 TLS/SSL</p>
<p>静态文件的惊人快速处理</p>
<p>带缓存的 FastCGI 支持 (PHP)</p>
<p>反向代理</p>
<p>Linux 用户发现配置此 Web 服务器很容易，但对于新用户来说，这可能会令人困惑。本指南通过演示如何使用NGINXConfig轻松生成这些 Nginx 配置来解决这一难题。</p>
<p>第 1 步 – 安装所需的软件包<br>由于我们将从 GitHub 克隆 NGINXConfig，因此我们需要安装 git：</p>
<p>在 RHEL/CentOS/Rocky Linux 8/Alma Linux 8上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install git</span><br></pre></td></tr></table></figure>

<p>在Debian / Ubuntu</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install git</span><br></pre></td></tr></table></figure>

<p>在 RHEL/CentOS/Rocky Linux 8/Alma Linux 8上</p>
<p>接下来，安装开发工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y groupinstall &#x27;Development Tools&#x27;</span><br><span class="line">sudo yum -y install ncurses-devel make gcc bc openssl-devel</span><br><span class="line">sudo yum -y install python3</span><br></pre></td></tr></table></figure>

<p>在Debian / Ubuntu</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curl build-essential python3</span><br><span class="line">sudo apt install libncurses-dev flex libssl-dev libelf-dev bc bison</span><br></pre></td></tr></table></figure>

<img src="../img/20220428-1.png" >

<p>现在在您的系统上安装 NodeJS：</p>
<p>在Debian / Ubuntu</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL &lt;https://deb.nodesource.com/setup_14.x&gt; | sudo bash -</span><br><span class="line">sudo apt -y install nodejs</span><br></pre></td></tr></table></figure>

<p>在 RHEL/CentOS/Rocky Linux 8/Alma Linux 8上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL &lt;https://rpm.nodesource.com/setup_14.x&gt; | sudo bash -</span><br><span class="line">sudo yum -y install nodejs</span><br></pre></td></tr></table></figure>

<p>验证安装。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">linuxmi@linuxmi /home/linuxmi/www.linuxmi.com</span><br><span class="line">⚡ node -v</span><br><span class="line">v17.9.0</span><br></pre></td></tr></table></figure>

<img src="../img/20220428-2.png" >

<p>第 2 步 – 在 Linux 上安装 NGINXConfig<br>现在我们将使用以下命令克隆系统上的 GitHub 存储库：</p>
<p>linuxmi@linuxmi /home/linuxmi/<a target="_blank" rel="noopener" href="http://www.linuxmi.com/">www.linuxmi.com</a><br>⚡ git clone <a target="_blank" rel="noopener" href="https://github.com/digitalocean/nginxconfig.io.git">https://github.com/digitalocean/nginxconfig.io.git</a></p>
<img src="../img/20220428-3.png" >

<p>导航到目录：</p>
<p>linuxmi@linuxmi /home/linuxmi/<a target="_blank" rel="noopener" href="http://www.linuxmi.com/">www.linuxmi.com</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">⚡ cd nginxconfig.io</span><br></pre></td></tr></table></figure>

<p>进入目录后，安装所需的 NPM 包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">linuxmi@linuxmi /home/linuxmi/www.linuxmi.com</span><br><span class="line">npm install</span><br><span class="line">npm ci</span><br></pre></td></tr></table></figure>

<p>如果您启用了防火墙，您可能需要允许该服务通过防火墙。默认情况下，它运行在8080端口，如果该端口正在使用，服务将监听8081端口</p>
<p>对于 Firewalld</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port=8080/tcp --permanent sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>对于 ufw</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">linuxmi@linuxmi /home/linuxmi/www.linuxmi.com/nginxconfig.io    master</span><br><span class="line">⚡ sudo ufw allow 8080</span><br></pre></td></tr></table></figure>

<p>防火墙规则已更新<br>规则已更新(v6)</p>
<img src="../img/20220428-4.png" >

<p>现在运行 NGINXConfig 开发服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">linuxmi@linuxmi /home/linuxmi/www.linuxmi.com/nginxconfig.io    master</span><br><span class="line">⚡ npm run dev</span><br></pre></td></tr></table></figure>

<img src="../img/20220428-5.png" >

<img src="../img/20220428-6.png" >

<p>此时，应该可以使用提供的 URL <a href="http://localhost:8080或http://serverip:8080">http://localhost:8080或http://serverip:8080</a>访问 NGINXConfig 开发服务器</p>
<img src="../img/20220428-7.png" >

<p>您也可以使用以下命令构建用于生产的服务器：</p>
<p>npm run build<br>构建过程完成后，您将创建dist文件夹。您可以使用安装的 Node.js 静态文件服务器来提供文件夹中的内容，如下所示：</p>
<p>sudo npm install -g serve<br>第 3 步 – 使用 NGINXConfig 生成 Nginx 配置文件。<br>在浏览器上打开提供的 URL。现在通过提供域名、路径和文档根目录来创建一个 Nginx 配置文件。您还可以选择预设模板。</p>
<img src="../img/20220428-8.png" >

<p>如果您想为您的网站使用HTTPS ，您可以继续并进行调整。如果没有，您可以通过取消选中该框来禁用它</p>
<img src="../img/20220428-9.png" >

<p>在这里，您还可以设置证书类型、自定义或来自 Let’s Encrypt。</p>
<p>接下来，如果站点是基于 PHP 的，则配置 PHP。</p>
<img src="../img/20220428-10.png" >

<p>根据站点进行其他配置，这些配置包括；Python、反向代理、站点日志等</p>
<img src="../img/20220428-11.png" >

<p>现在您将根据所做的配置准备好 Nginx conf 文件。</p>
<p>以下是示例文件：</p>
<img src="../img/20220428-12.png" >

<p>您可以选择将文件复制到提供的文件夹或下载压缩配置文件并将其上传到服务器的/etc/nginx目录。</p>
<p>下载 生成的配置: nginxconfig.io-linuxmi.com.tar.gz<br>然后 上传 到你的服务器的/etc/nginx 目录.</p>
<p>或, 复制压缩配置的base64字符串，将其粘贴到服务器的命令行并执行。</p>
<p>进入你的 NGINX服务器上的配置目录:<br>cd /etc/nginx</p>
<p>创建当前NGINX配置的备份:<br>tar -czvf nginx_$(date +’%F_%H-%M-%S’).tar.gz nginx.conf sites-available/ sites-enabled/ nginxconfig.io/</p>
<p>使用tar解压新的压缩配置<br>tar -xzvf nginxconfig.io-linuxmi.com.tar.gz | xargs chmod 0644<br>您也可以复制压缩配置的base64 字符串并将其粘贴到服务器的命令行中以执行它。</p>
<p>复制到所需文件夹后，启用 conf，重新启动 Nginx，然后访问该站点。</p>
<h5 id="创建当前NGINX配置的备份"><a href="#创建当前NGINX配置的备份" class="headerlink" title="创建当前NGINX配置的备份"></a>创建当前NGINX配置的备份</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -czvf nginx_$(date +&#x27;%F_%H-%M-%S&#x27;).tar.gz nginx.conf sites-available/ sites-enabled/ nginxconfig.io/</span><br></pre></td></tr></table></figure>

<h6 id="使用tar提取新的压缩配置档案"><a href="#使用tar提取新的压缩配置档案" class="headerlink" title="使用tar提取新的压缩配置档案"></a>使用tar提取新的压缩配置档案</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xzvf nginxconfig.io-nginx.ww.linuxmi.com.tar.gz | xargs chmod 0644</span><br><span class="line">x nginx.conf</span><br><span class="line">x sites-available/nginx.ww.linuxmi.com.conf</span><br><span class="line">x sites-enabled/nginx.ww.linuxmi.com.conf</span><br><span class="line">x nginxconfig.io/letsencrypt.conf</span><br><span class="line">x nginxconfig.io/security.conf</span><br><span class="line">x nginxconfig.io/general.conf</span><br><span class="line">x nginxconfig.io/php_fastcgi.conf</span><br></pre></td></tr></table></figure>

<h6 id="移动文件和文件夹"><a href="#移动文件和文件夹" class="headerlink" title="移动文件和文件夹"></a>移动文件和文件夹</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mv nginx.conf /etc/nginx/nginx.conf</span><br><span class="line">sudo mv nginxconfig.io /etc/nginx/nginxconfig.io</span><br><span class="line">sudo mv sites-available/* /etc/nginx/conf.d/</span><br></pre></td></tr></table></figure>

<h6 id="验证配置"><a href="#验证配置" class="headerlink" title="验证配置"></a>验证配置</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure>

<p>就是这么容易！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/05/nginx%E9%AB%98%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Well Wang">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Well Wang的blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/05/nginx%E9%AB%98%E5%B9%B6%E5%8F%91%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/" class="post-title-link" itemprop="url">nginx高并发调优</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-06-05 00:00:00 / 修改时间：15:31:52" itemprop="dateCreated datePublished" datetime="2022-06-05T00:00:00+08:00">2022-06-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一、nigxin配置文件优化</p>
<p>设置nginx进程数，推荐按照cpu数目来指定，一般跟cpu核数相同。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 8;</span><br></pre></td></tr></table></figure>

<p>为每个进程分配cpu，上例中将8个进程分配到8个cpu，当然可以写多个，或者将一个进程分配到多个cpu。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_cpu_affinity 0001 0010 0011 0100 0101 0110 0111 1000;</span><br></pre></td></tr></table></figure>

<p>配置nginx进程打开的最多文件数目，理论值应该是系统的最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx分配请求并不是那么均匀，所以最好与ulimit -n的值保持一致。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure>

<p>使用epoll的I/O模型，用这个模型来高效处理异步事件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use epoll;</span><br></pre></td></tr></table></figure>

<pre><code>每个进程允许的最多连接数，理论上每台nginx服务器的最大连接数为
</code></pre>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes*worker_connections。</span><br><span class="line">worker_connections 65535;</span><br></pre></td></tr></table></figure>

<p>http连接超时时间，默认是60s，功能是使客户端到服务器端的连接在设定的时间内持续有效，当出现对服务器的后继请求时，该功能避免了建立或者重新建立连接。切记这个参数也不能设置过大！否则会导致许多无效的http连接占据着nginx的连接数，终nginx崩溃！</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keepalive_timeout 60;</span><br></pre></td></tr></table></figure>

<p>客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般一个请求的头部大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。分页大小可以用命令getconf PAGESIZE取得。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_header_buffer_size 4k;</span><br></pre></td></tr></table></figure>

<p>下面这个参数将为打开文件指定缓存，默认是没有启用的，max指定缓存数量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删除缓存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=102400 inactive=20s;</span><br></pre></td></tr></table></figure>

<p>下面这个是指多长时间检查一次缓存的有效信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache_valid 30s;</span><br></pre></td></tr></table></figure>

<p>open_file_cache指令中的inactive参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive时间内一次没被使用，它将被移除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache_min_uses 1;</span><br></pre></td></tr></table></figure>

<p>隐藏响应头中的有关操作系统和web server（Nginx）版本号的信息，这样对于安全性是有好处的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_tokens off;</span><br></pre></td></tr></table></figure>

<p>可以让sendfile()发挥作用。sendfile()可以在磁盘和TCP socket之间互相拷贝数据(或任意两个文件描述符)。Pre-sendfile是传送数据之前在用户空间申请数据缓冲区。之后用read()将数据从文件拷贝到这个缓冲区，write()将缓冲区数据写入网络。sendfile()是立即将数据从磁盘读到OS缓存。因为这种拷贝是在内核完成的，sendfile()要比组合read()和write()以及打开关闭丢弃缓冲更加有效(更多有关于sendfile)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br></pre></td></tr></table></figure>

<p>告诉nginx在一个数据包里发送所有头文件，而不一个接一个的发送。就是说数据包不会马上传送出去，等到数据包最大时，一次性的传输出去，这样有助于解决网络堵塞。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp_nopush on;</span><br></pre></td></tr></table></figure>

<p>告诉nginx不要缓存数据，而是一段一段的发送–当需要及时发送数据时，就应该给应用设置这个属性，这样发送一小块数据信息时就不能立即得到返回值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tcp_nodelay on;</span><br><span class="line">比如：</span><br><span class="line">http &#123;undefined</span><br><span class="line">server_tokens off;</span><br><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">…</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端请求头部的缓冲区大小，这个可以根据系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_header_buffer_size 4k;</span><br></pre></td></tr></table></figure>

<p>客户端请求头部的缓冲区大小，这个可以根据系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。</p>
<p>分页大小可以用命令getconf PAGESIZE取得。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test-huanqiu ~]<span class="comment"># getconf PAGESIZE</span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure>

<p>但也有client_header_buffer_size超过4k的情况，但是client_header_buffer_size该值必须设置为“系统分页大小”的整倍数。<br>为打开文件指定缓存，默认是没有启用的，max 指定缓存数量，建议和打开文件数一致，inactive 是指经过多长时间文件没被请求后删除缓存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache max=65535 inactive=60s;</span><br></pre></td></tr></table></figure>

<p>open_file_cache 指令中的inactive 参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive 时间内一次没被使用，它将被移除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache_min_uses 1;</span><br></pre></td></tr></table></figure>

<p>指定多长时间检查一次缓存的有效信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open_file_cache_valid 80s;</span><br></pre></td></tr></table></figure>

<p>========================================================================<br>如下一个运维日常用的nginx标准配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-huanqiu ~]<span class="comment"># cat /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line">user   www www;</span><br><span class="line">worker_processes 8;</span><br><span class="line">worker_cpu_affinity 00000001 00000010 00000100 00001000 00010000 00100000 01000000;</span><br><span class="line">error_log   /www/log/nginx_error.log   crit;</span><br><span class="line">pid         /usr/local/nginx/nginx.pid;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line"></span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">   use epoll;</span><br><span class="line">   worker_connections 65535;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">   include       mime.types;</span><br><span class="line">   default_type   application/octet-stream;</span><br><span class="line"></span><br><span class="line">   charset   utf-8;</span><br><span class="line"></span><br><span class="line">   server_names_hash_bucket_size 128;</span><br><span class="line">   client_header_buffer_size 2k;</span><br><span class="line">   large_client_header_buffers 4 4k;</span><br><span class="line">   client_max_body_size 8m;</span><br><span class="line"></span><br><span class="line">   sendfile on;</span><br><span class="line">   tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">   keepalive_timeout 60;</span><br><span class="line"></span><br><span class="line">   fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=1:2</span><br><span class="line">                 keys_zone=TEST:10m</span><br><span class="line">                 inactive=5m;</span><br><span class="line">   fastcgi_connect_timeout 300;</span><br><span class="line">   fastcgi_send_timeout 300;</span><br><span class="line">   fastcgi_read_timeout 300;</span><br><span class="line">   fastcgi_buffer_size 16k;</span><br><span class="line">   fastcgi_buffers 16 16k;</span><br><span class="line">   fastcgi_busy_buffers_size 16k;</span><br><span class="line">   fastcgi_temp_file_write_size 16k;</span><br><span class="line">   fastcgi_cache TEST;</span><br><span class="line">   fastcgi_cache_valid 200 302 1h;</span><br><span class="line">   fastcgi_cache_valid 301 1d;</span><br><span class="line">   fastcgi_cache_valid any 1m;</span><br><span class="line">   fastcgi_cache_min_uses 1;</span><br><span class="line">   fastcgi_cache_use_stale error <span class="built_in">timeout</span> invalid_header http_500;</span><br><span class="line">   open_file_cache max=204800 inactive=20s;</span><br><span class="line">   open_file_cache_min_uses 1;</span><br><span class="line">   open_file_cache_valid 30s;</span><br><span class="line"></span><br><span class="line">   tcp_nodelay on;</span><br><span class="line"></span><br><span class="line">   gzip on;</span><br><span class="line">   gzip_min_length   1k;</span><br><span class="line">   gzip_buffers     4 16k;</span><br><span class="line">   gzip_http_version 1.0;</span><br><span class="line">   gzip_comp_level 2;</span><br><span class="line">   gzip_types       text/plain application/x-javascript text/css application/xml;</span><br><span class="line">   gzip_vary on;</span><br><span class="line"></span><br><span class="line">   server</span><br><span class="line">   &#123;</span><br><span class="line">     listen       8080;</span><br><span class="line">     server_name   huan.wangshibo.com;</span><br><span class="line">     index index.php index.htm;</span><br><span class="line">     root   /www/html/;</span><br><span class="line"></span><br><span class="line">     location /status</span><br><span class="line">     &#123;</span><br><span class="line">         stub_status on;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     location ~ .*\.(php|php5)?$</span><br><span class="line">     &#123;</span><br><span class="line">         fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">         fastcgi_index index.php;</span><br><span class="line">         include fcgi.conf;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|js|css)$</span><br><span class="line">     &#123;</span><br><span class="line">       expires       30d;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     log_format   access   <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">               <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">               <span class="string">&#x27;&quot;$http_user_agent&quot; $http_x_forwarded_for&#x27;</span>;</span><br><span class="line">     access_log   /www/log/access.log   access;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="二、关于FastCGI的几个指令"><a href="#二、关于FastCGI的几个指令" class="headerlink" title="二、关于FastCGI的几个指令"></a>二、关于FastCGI的几个指令</h4><p>这个指令为FastCGI缓存指定一个路径，目录结构等级，关键字区域存储时间和非活动删除时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache_path /usr/local/nginx/fastcgi_cache levels=1:2 keys_zone=TEST:10m inactive=5m;</span><br></pre></td></tr></table></figure>

<p>指定连接到后端FastCGI的超时时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_connect_timeout 300;</span><br></pre></td></tr></table></figure>

<p>向FastCGI传送请求的超时时间，这个值是指已经完成两次握手后向FastCGI传送请求的超时时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_send_timeout 300;</span><br></pre></td></tr></table></figure>

<p>接收FastCGI应答的超时时间，这个值是指已经完成两次握手后接收FastCGI应答的超时时间。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_read_timeout 300;</span><br></pre></td></tr></table></figure>

<p>指定读取FastCGI应答第一部分 需要用多大的缓冲区，这里可以设置为fastcgi_buffers指令指定的缓冲区大小，上面的指令指定它将使用1个 16k的缓冲区去读取应答的第一部分，即应答头，其实这个应答头一般情况下都很小（不会超过1k），但是你如果在fastcgi_buffers指令中指 定了缓冲区的大小，那么它也会分配一个fastcgi_buffers指定的缓冲区大小去缓存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_buffer_size 16k;</span><br></pre></td></tr></table></figure>

<p>指定本地需要用多少和多大的缓冲区来 缓冲FastCGI的应答，如上所示，如果一个php脚本所产生的页面大小为256k，则会为其分配16个16k的缓冲区来缓存，如果大于256k，增大 于256k的部分会缓存到fastcgi_temp指定的路径中， 当然这对服务器负载来说是不明智的方案，因为内存中处理数据速度要快于硬盘，通常这个值 的设置应该选择一个你的站点中的php脚本所产生的页面大小的中间值，比如你的站点大部分脚本所产生的页面大小为 256k就可以把这个值设置为16 16k，或者4 64k 或者64 4k，但很显然，后两种并不是好的设置方法，因为如果产生的页面只有32k，如果用4 64k它会分配1个64k的缓冲区去缓存，而如果使用64 4k它会分配8个4k的缓冲区去缓存，而如果使用16 16k则它会分配2个16k去缓存页面，这样看起来似乎更加合理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_buffers 16 16k;</span><br></pre></td></tr></table></figure>

<p>这个指令我也不知道是做什么用，只知道默认值是fastcgi_buffers的两倍。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_busy_buffers_size 32k;</span><br></pre></td></tr></table></figure>

<p>在写入fastcgi_temp_path时将用多大的数据块，默认值是fastcgi_buffers的两倍。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_temp_file_write_size 32k;</span><br></pre></td></tr></table></figure>

<p>开启FastCGI缓存并且为其制定一个名称。个人感觉开启缓存非常有用，可以有效降低CPU负载，并且防止502错误。但是这个缓存会引起很多问题，因为它缓存的是动态页面。具体使用还需根据自己的需求。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache TEST</span><br></pre></td></tr></table></figure>

<p>为指定的应答代码指定缓存时间，如上例中将200，302应答缓存一小时，301应答缓存1天，其他为1分钟。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache_valid 200 302 1h;</span><br><span class="line">fastcgi_cache_valid 301 1d;</span><br><span class="line">fastcgi_cache_valid any 1m;</span><br></pre></td></tr></table></figure>

<p>缓存在fastcgi_cache_path指令inactive参数值时间内的最少使用次数，如上例，如果在5分钟内某文件1次也没有被使用，那么这个文件将被移除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache_min_uses 1;</span><br></pre></td></tr></table></figure>

<p>不知道这个参数的作用，猜想应该是让nginx知道哪些类型的缓存是没用的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_cache_use_stale error <span class="built_in">timeout</span> invalid_header http_500;</span><br></pre></td></tr></table></figure>

<p>注：，*FastCGI自身也有一些配置需要进行优化，如果你使用php-fpm来管理FastCGI，可以修改配置文件中的以下值：<br>同时处理的并发请求数，即它将开启最多60个子线程来处理并发连接。<br>60<br>最多打开文件数。<br>65535<br>每个进程在重置之前能够执行的最多请求数。<br>65535</p>
<h4 id="三-关于内核参数的优化，在-etc-sysctl-conf文件内"><a href="#三-关于内核参数的优化，在-etc-sysctl-conf文件内" class="headerlink" title="三. 关于内核参数的优化，在/etc/sysctl.conf文件内"></a>三. 关于内核参数的优化，在/etc/sysctl.conf文件内</h4><ol>
<li>timewait的数量，默认是180000。(Deven:因此如果想把timewait降下了就要把tcp_max_tw_buckets值减小)<br> net.ipv4.tcp_max_tw_buckets = 6000</li>
<li>允许系统打开的端口范围。<br> net.ipv4.ip_local_port_range = 1024 65000</li>
<li>启用TIME-WAIT状态sockets快速回收功能;用于快速减少在TIME-WAIT状态TCP连接数。1表示启用;0表示关闭。但是要特别留意的是：这个选项一般不推荐启用，因为在NAT(Network Address Translation)网络下，会导致大量的TCP连接建立错误，从而引起网站访问故障。<br> net.ipv4.tcp_tw_recycle = 0</li>
</ol>
<p>实际上，net.ipv4.tcp_tw_recycle功能的开启，一般需要net.ipv4.tcp_timestamps（一般系统默认是开启这个功能的）这个开关开启后才有效果；<br>当tcp_tw_recycle 开启时（tcp_timestamps 同时开启，快速回收 socket 的效果达到），对于位于NAT设备后面的 Client来说，是一场灾难！！会导致到NAT设备后面的Client连接Server不稳定（有的 Client 能连接 server，有的 Client 不能连接 server）。</p>
<p>tcp_tw_recycle这个功能，其实是为内部网络（网络环境自己可控 ” -不存在NAT 的情况）设计的，对于公网环境下，不宜使用。通常来说，回收TIME_WAIT状态的socket是因为“无法主动连接远端”，因为无可用的端口，而不应该是要回收内存（没有必要）。也就是说，需求是Client的需求，Server会有“端口不够用”的问题吗？除非是前端机，需要大量的连接后端服务，也就是充当着Client的角色。</p>
<p>正确的解决这个总是办法应该是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_local_port_range = 9000 6553            <span class="comment">#默认值范围较小</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 10000                 <span class="comment">#默认值较小，还可适当调小</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 10</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>开启重用功能，允许将TIME-WAIT状态的sockets重新用于新的TCP连接。这个功能启用是安全的，一般不要去改动！<br> net.ipv4.tcp_tw_reuse = 1</li>
<li>开启SYN Cookies，当出现SYN等待队列溢出时，启用cookies来处理。<br> net.ipv4.tcp_syncookies = 1</li>
<li>web应用中listen函数的backlog默认会给我们内核参数的net.core.somaxconn限制到128，而nginx定义的NGX_LISTEN_BACKLOG默认为511，所以有必要调整这个值。<br> net.core.somaxconn = 262144</li>
<li>每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。<br> net.core.netdev_max_backlog = 262144</li>
<li>系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤儿连接将即刻被复位并打印出警告信息。这个限制仅仅是为了防止简单的DoS攻击，不能过分依靠它或者人为地减小这个值，更应该增加这个值(如果增加了内存之后)。<br> net.ipv4.tcp_max_orphans = 262144</li>
<li>记录的那些尚未收到客户端确认信息的连接请求的最大值。对于有128M内存的系统而言，缺省值是1024，小内存的系统则是128。<br> net.ipv4.tcp_max_syn_backlog = 262144</li>
<li>时间戳可以避免序列号的卷绕。一个1Gbps的链路肯定会遇到以前用过的序列号。时间戳能够让内核接受这种“异常”的数据包。<br>net.ipv4.tcp_timestamps = 1</li>
<li>有不少服务器为了提高性能，开启net.ipv4.tcp_tw_recycle选项，在NAT网络环境下，容易导致网站访问出现了一些connect失败的问题。<br>个人建议：<br>关闭net.ipv4.tcp_tw_recycle选项，而不是net.ipv4.tcp_timestamps；因为在net.ipv4.tcp_timestamps关闭的条件下，开启net.ipv4.tcp_tw_recycle是不起作用的；而net.ipv4.tcp_timestamps可以独立开启并起作用。</li>
<li>为了打开对端的连接，内核需要发送一个SYN并附带一个回应前面一个SYN的ACK。也就是所谓三次握手中的第二次握手。这个设置决定了内核放弃连接之前发送SYN+ACK包的数量。<br>net.ipv4.tcp_synack_retries = 1</li>
<li>在内核放弃建立连接之前发送SYN包的数量。<br>net.ipv4.tcp_syn_retries = 1</li>
<li>如果套接字由本端要求关闭，这个参数 决定了它保持在FIN-WAIT-2状态的时间。对端可以出错并永远不关闭连接，甚至意外当机。缺省值是60秒。2.2 内核的通常值是180秒，你可以按这个设置，但要记住的是，即使你的机器是一个轻载的WEB服务器，也有因为大量的死套接字而内存溢出的风险，FIN- WAIT-2的危险性比FIN-WAIT-1要小，因为它最多只能吃掉1.5K内存，但是它们的生存期长些。<br>net.ipv4.tcp_fin_timeout = 30</li>
<li>当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时。<br>net.ipv4.tcp_keepalive_time = 30<br>以下是一个常用的内核参数的标准配置</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@dev-huanqiu ~]<span class="comment"># cat /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.ip_forward = 0</span><br><span class="line">net.ipv4.conf.default.rp_filter = 1</span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line">kernel.sysrq = 0</span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line">net.ipv4.tcp_syncookies = 1            //这四行标红内容，一般是发现大量TIME_WAIT时的解决办法</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.shmmax = 68719476736</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 6000</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 4194304</span><br><span class="line">net.ipv4.tcp_wmem = 4096 16384 4194304</span><br><span class="line">net.core.wmem_default = 8388608</span><br><span class="line">net.core.rmem_default = 8388608</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line">net.core.netdev_max_backlog = 262144</span><br><span class="line">net.core.somaxconn = 262144</span><br><span class="line">net.ipv4.tcp_max_orphans = 3276800</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 262144</span><br><span class="line">net.ipv4.tcp_timestamps = 1            //在net.ipv4.tcp_tw_recycle设置为1的时候，这个选择最好加上</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1           //开启此功能可以减少TIME-WAIT状态，但是NAT网络模式下打开有可能会导致tcp连接错误，慎重。</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_mem = 94500000 915000000 927000000</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.tcp_keepalive_time = 30</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class="line">net.ipv4.ip_conntrack_max = 6553500</span><br></pre></td></tr></table></figure>

<p><strong>注：</strong><br> net.ipv4.tcp_tw_recycle = 1 这个功能打开后，确实能减少TIME-WAIT状态，但是打开这个参数后，会导致大量的TCP连接建立错误，从而引起网站访问故障。</p>
<p>Nginx安全配置小提示</p>
<p>下面是一个常见安全陷阱和解决方案的列表，它可以辅助来确保你的Nginx部署是安全的。</p>
<ol>
<li> 禁用autoindex模块。这个可能在你使用的Nginx版本中已经更改了，如果没有的话只需在配置文件的location块中增加autoindex off;声明即可。</li>
<li> 禁用服务器上的ssi (服务器端引用)。这个可以通过在location块中添加ssi off; 。</li>
<li> 关闭服务器标记。如果开启的话（默认情况下）所有的错误页面都会显示服务器的版本和信息。将server_tokens off;声明添加到Nginx配置文件来解决这个问题。</li>
<li> 在配置文件中设置自定义缓存以限制缓冲区溢出攻击的可能性。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client_body_buffer_size  1K;</span><br><span class="line">client_header_buffer_size 1k;</span><br><span class="line">client_max_body_size 1k;</span><br><span class="line">large_client_header_buffers 2 1k;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li> 将timeout设低来防止DOS攻击。所有这些声明都可以放到主配置文件中</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client_body_timeout   10;</span><br><span class="line">client_header_timeout 10;</span><br><span class="line">keepalive_timeout     65;</span><br><span class="line">send_timeout          10;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li> 限制用户连接数来预防DOS攻击。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limit_zone slimits <span class="variable">$binary_remote_addr</span> 5m;</span><br><span class="line">limit_conn slimits 5;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li> 试着避免使用HTTP认证。HTTP认证默认使用crypt，它的哈希并不安全。如果你要用的话就用MD5（这也不是个好选择但负载方面比crypt好）</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Well Wang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Well Wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
